name: CI/CD Pipeline - NodeJS Express Template

# Workflow to validate the Express Kickstart Boilerplate using Node.js 20.x standards.

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Set default permissions for GitHub Actions
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  lint_and_test:
    name: Lint & Unit Test
    runs-on: ubuntu-latest
    # Utilizing Node 20 LTS (2025 Standard for stable Express environments)
    defaults:
      run:
        working-directory: ./server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      - name: Install Dependencies
        run: npm ci

      - name: Run EJS/Express Linter Check (Example: ESLint/Biome Check)
        # Assuming standard project setup uses npm scripts for validation
        run: npm run lint || true # Use || true if linting is purely informative, otherwise fail fast

      - name: Execute Unit Tests (Vitest/Jest Placeholder)
        # Replace with actual test command (e.g., npm test or npm run test:unit)
        run: npm test

      - name: Generate Code Coverage Report
        run: npm run test:coverage # Assumes this script generates a lcov.info file
        continue-on-error: true

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./server/coverage/lcov.info
          flags: unittests
          name: Express-Kickstart-CI

  security_scan:
    name: Static Analysis & Security Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies (For Security Tools)
        run: npm ci

      - name: Check Dependencies for Vulnerabilities (npm audit)
        run: npm audit --production --audit-level=high
        # This step will fail the workflow if high-severity issues are found

  docker_build:
    name: Docker Build & Tag
    runs-on: ubuntu-latest
    needs: [lint_and_test]
    if: github.ref == 'refs/heads/main'
    permissions:
      packages: write
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/chirag127/express-kickstart:${{ github.sha }}
          labels: org.opencontainers.image.source=https://github.com/chirag127/Express-Kickstart-NodeJS-Web-App-Template
